{"version":3,"sources":["../../src/routes/chat.route.ts"],"sourcesContent":["import { Router } from 'express';\nimport { Routes } from '@interfaces/routes.interface';\nimport Anthropic from '@anthropic-ai/sdk';\nimport axios from 'axios';\nimport multer from 'multer';\nimport FormData from 'form-data';\nimport dotenv from 'dotenv';\nimport { Tool } from '@anthropic-ai/sdk/resources';\ndotenv.config();\n\nexport class ChatRoute implements Routes {\n  public path = '/api/chat';\n  public router = Router();\n  private anthropic: Anthropic;\n  private upload = multer();\n  private readonly SYSTEM_PROMPT = `You are a sarcastic, faustian concise bot who speaks in HTML. \n\nYour responses should be wrapped in semantic HTML tags that convey meaning and structure.\nUse <p> for paragraphs, <em> for emphasis, <strong> for important points, and other appropriate tags.\n\nDon't talk about the tools you use for each response.  \nIf the user's response is not valid, ask clearly for clarification.\nMake sure to set is valid or not every response\n\nIf you don't set valid to true, then fucking ASK for clarification.  You should never have a response that isn't valid yet doesn't ask for clarification.\n\nASK FOR CLARIFICATION OR SET VALID TO TRUE\n\nFormat your responses like:\n<div>\n  <p>your message...</p>\n</div>`;\n\n  private readonly TOOLS: Tool[] = [\n    {\n      name: 'setProblem',\n      description: 'Set the problem as the user states it',\n      input_schema: {\n        type: 'object',\n        properties: {\n          problem: {\n            type: 'string',\n            description: 'The users problem',\n          },\n        },\n        required: ['problem'],\n      },\n    },\n    {\n      name: 'setBasicProblem',\n      description: 'Set a really milquetoast way of rephrasing their problem',\n      input_schema: {\n        type: 'object',\n        properties: {\n          basicProblem: {\n            type: 'string',\n            description: 'The lame problem description',\n          },\n        },\n      },\n    },\n    {\n      name: 'setBasicSolution',\n      description: 'Set a really stupid set of simple steps to answer the users stated problem',\n      input_schema: {\n        type: 'object',\n        properties: {\n          basicSolution: {\n            type: 'string',\n            description: 'The lame solution description',\n          },\n        },\n        required: ['basicSolution'],\n      },\n    },\n    {\n      name: 'setAgreedToPact',\n      description: 'Set whether the user agreed to the pact',\n      input_schema: {\n        type: 'object',\n        properties: {\n          agreedToPact: {\n            type: 'boolean',\n            description: 'Whether the user agreed to the pact',\n          },\n        },\n      },\n    },\n\n    {\n      name: 'setIsValidResponse',\n      description: 'If the user response is valid, to the question being asked, set the isValidResponse to true',\n      input_schema: {\n        type: 'object',\n        properties: {\n          isValidResponse: {\n            type: 'boolean',\n            description: 'Whether their response is clear enough',\n          },\n        },\n        required: ['isValidResponse'],\n      },\n    },\n  ];\n\n  constructor() {\n    console.log('test')\n    this.anthropic = new Anthropic({\n      apiKey: process.env.CLAUDE_API_KEY,\n    });\n    this.initializeRoutes();\n  }\n\n  private initializeRoutes() {\n    this.router.post(this.path, this.handleChatRequest.bind(this));\n    this.router.post(`${this.path}/upload`, this.upload.single('image'), this.handleImageUpload.bind(this));\n    this.router.post(`${this.path}/isFulfilled`, this.handleTaskFulfillment.bind(this));\n    this.router.post(`${this.path}/selectSolution`, this.handleSolutionSelection.bind(this));\n  }\n\n  private async handleSolutionSelection(req, res) {\n    try {\n      const { userProblem, solutions } = req.body;\n\n      if (!userProblem || !solutions) {\n        return res.status(400).json({ error: 'User problem and solutions are required' });\n      }\n\n      const response = await this.anthropic.messages.create({\n        model: 'claude-3-5-haiku-20241022',\n        system:\n          this.SYSTEM_PROMPT +\n          \"\\nSelect the most appropriate solution for the mortal's problem from the given options and set it as their esoteric solution.\",\n        messages: [\n          {\n            role: 'user',\n            content: `User Problem: ${userProblem}\\n\\nAvailable Solutions:\\n${solutions\n              .map((s, i) => `${i}: ${s}`)\n              .join('\\n')}\\n\\nWhich solution best matches the user's problem? Use setDeepSolution to set it.`,\n          },\n        ],\n        tools: [\n          {\n            name: 'setSolution',\n            description: 'Set the selected solution for the user',\n            input_schema: {\n              type: 'object',\n              properties: {\n                deepSolution: {\n                  type: 'number',\n                  description: 'The index of the selected solution in the list',\n                },\n              },\n              required: ['deepSolution'],\n            },\n          },\n        ],\n        max_tokens: 4096,\n      });\n\n      return res.json({\n        ...response.content,\n      });\n    } catch (error) {\n      console.error('Solution selection error:', error);\n      res.status(500).json({ error: 'Error selecting solution' });\n    }\n  }\n\n  private async handleTaskFulfillment(req, res) {\n    try {\n      const { task, validator, messages } = req.body;\n\n      const response = await this.anthropic.messages.create({\n        model: 'claude-3-5-sonnet-20241022',\n        system: `\\nYour task is to determine if the provided evidence demonstrates completion of this task ${task} with by answering this validation question: ${validator}`,\n        messages: [...messages],\n        tools: [\n          {\n            name: 'validateTaskCompletion',\n            description: 'Validate if the evidence demonstrates task completion and explain why',\n            input_schema: {\n              type: 'object',\n              properties: {\n                isComplete: {\n                  type: 'boolean',\n                  description: 'Whether the evidence demonstrates task completion',\n                },\n                explanation: {\n                  type: 'string',\n                  description: 'Explanation of why the evidence is or is not sufficient',\n                },\n              },\n              required: ['isComplete', 'explanation'],\n            },\n          },\n        ],\n        max_tokens: 4096,\n      });\n\n      res.json({\n        ...response.content,\n      });\n    } catch (error) {\n      console.error('Task fulfillment error:', error);\n      res.status(500).json({ error: 'Error verifying task fulfillment' });\n    }\n  }\n\n  private async handleChatRequest(req, res) {\n    try {\n      const { messages, validationPhrase, programState } = req.body;\n\n      const formattedMessages = messages.map(({ role, content, imageUrl }) => {\n        if (imageUrl) {\n          return {\n            role: role === 'assistant' ? 'assistant' : 'user',\n            content: `${content}\\n[Image: ${imageUrl}]`,\n          };\n        }\n        return {\n          role: role === 'assistant' ? 'assistant' : 'user',\n          content,\n        };\n      });\n\n      // Get AI's response\n      const message = await this.anthropic.messages.create({\n        model: 'claude-3-5-sonnet-20241022',\n        system: this.SYSTEM_PROMPT + ` This is the validation phrase: ${validationPhrase}`,\n        messages: formattedMessages,\n        tools: this.TOOLS,\n        max_tokens: 4096,\n      });\n\n      res.json({\n        ...message.content,\n      });\n    } catch (error) {\n      console.error(error);\n      res.status(500).json({ error: 'Error processing chat request' });\n    }\n  }\n}\n"],"names":["ChatRoute","dotenv","config","initializeRoutes","router","post","path","handleChatRequest","bind","upload","single","handleImageUpload","handleTaskFulfillment","handleSolutionSelection","req","res","userProblem","solutions","body","status","json","error","response","anthropic","messages","create","model","system","SYSTEM_PROMPT","role","content","map","s","i","join","tools","name","description","input_schema","type","properties","deepSolution","required","max_tokens","console","task","validator","isComplete","explanation","validationPhrase","programState","formattedMessages","imageUrl","message","TOOLS","constructor","Router","multer","problem","basicProblem","basicSolution","agreedToPact","isValidResponse","log","Anthropic","apiKey","process","env","CLAUDE_API_KEY"],"mappings":"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"}